---
description: CI/CD pipeline configuration and deployment automation guidelines
globs: [".github/workflows/**", "**/*.yml", "**/Dockerfile"]
alwaysApply: false
---
# CI/CD & Deployment Rules

## GitHub Actions Workflow

### CI Pipeline (.github/workflows/ci.yml)
```yaml
name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  backend:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: test_db
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'
      
      - name: Run tests
        run: ./gradlew test
        env:
          DATABASE_URL: jdbc:postgresql://localhost:5432/test_db
      
      - name: Build
        run: ./gradlew build
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
  
  frontend:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Lint
        run: npm run lint
      
      - name: Type check
        run: npm run type-check
      
      - name: Test
        run: npm test -- --coverage
      
      - name: Build
        run: npm run build
```

### Deployment Pipeline (.github/workflows/deploy.yml)
```yaml
name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2
      
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: Build and push Docker image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/digital-minimalist:$IMAGE_TAG .
          docker push $ECR_REGISTRY/digital-minimalist:$IMAGE_TAG
      
      - name: Deploy to ECS
        run: |
          aws ecs update-service \
            --cluster digital-minimalist-cluster \
            --service digital-minimalist-service \
            --force-new-deployment
```

## Docker Configuration

### Multi-stage Dockerfile
```dockerfile
# Backend build stage
FROM gradle:8-jdk17 AS backend-build
WORKDIR /app
COPY build.gradle settings.gradle ./
COPY src ./src
RUN gradle build -x test --no-daemon

# Frontend build stage
FROM node:18-alpine AS frontend-build
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
RUN npm run build

# Runtime stage
FROM eclipse-temurin:17-jre-alpine
WORKDIR /app

# Copy backend artifact
COPY --from=backend-build /app/build/libs/*.jar app.jar

# Copy frontend build
COPY --from=frontend-build /app/dist ./static

# Create non-root user
RUN addgroup -g 1001 -S appuser && \
    adduser -u 1001 -S appuser -G appuser
USER appuser

EXPOSE 8080

HEALTHCHECK --interval=30s --timeout=3s --start-period=40s --retries=3 \
  CMD wget --no-verbose --tries=1 --spider http://localhost:8080/actuator/health || exit 1

ENTRYPOINT ["java", "-jar", "app.jar"]
```

### docker-compose.yml (Development)
```yaml
version: '3.8'

services:
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: digital_minimalist
      POSTGRES_USER: dev
      POSTGRES_PASSWORD: dev
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
  
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
  
  kafka:
    image: confluentinc/cp-kafka:7.5.0
    environment:
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
    ports:
      - "9092:9092"
    depends_on:
      - zookeeper
  
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
    ports:
      - "2181:2181"

volumes:
  postgres_data:
  redis_data:
```

## Deployment Strategies

### Blue-Green Deployment
- Maintain two identical production environments (Blue, Green)
- Deploy to inactive environment, test, then switch traffic
- Instant rollback by switching back

### Rolling Deployment
- Gradually replace instances with new version
- Zero downtime deployment
- Slower rollout but safer

### Canary Deployment
- Deploy to small subset of users first (5-10%)
- Monitor metrics, gradually increase if stable
- Quick rollback if issues detected

## Monitoring & Observability
```yaml
# Prometheus metrics endpoint
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  metrics:
    export:
      prometheus:
        enabled: true
```

## Deployment Checklist
- [ ] Database migrations tested and reversible
- [ ] Environment variables configured
- [ ] Health checks passing
- [ ] Monitoring/alerting configured
- [ ] Backup strategy in place
- [ ] Rollback plan documented
- [ ] Load testing completed
- [ ] Security scan passed (OWASP dependency check)

## See also:
- [101-build-and-env-setup.mdc](101-build-and-env-setup.mdc)
- [106-environment-configuration.mdc](106-environment-configuration.mdc)
- [102-gitflow-agent.mdc](102-gitflow-agent.mdc)
